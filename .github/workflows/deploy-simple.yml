name: Deploy to GitHub Pages (Simple)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install --legacy-peer-deps
      
      - name: Verify API_KEY secret exists
        run: |
          if [ -z "${{ secrets.API_KEY }}" ]; then
            echo "❌ ERROR: API_KEY secret is not set!"
            echo ""
            echo "Please follow these steps:"
            echo "1. Go to: https://github.com/ilanit17/mental-imagery-app/settings/secrets/actions"
            echo "2. Click 'New repository secret'"
            echo "3. Name: API_KEY"
            echo "4. Value: Your Google Gemini API key"
            echo "5. Click 'Add secret'"
            echo "6. Run this workflow again"
            exit 1
          else
            echo "✅ API_KEY secret is set and ready for build"
          fi
      
      - name: Debug - Check API_KEY before build
        run: |
          if [ -z "${{ secrets.API_KEY }}" ]; then
            echo "❌ API_KEY is empty!"
            exit 1
          else
            echo "✅ API_KEY is set (first 10 chars: ${API_KEY:0:10}...)"
            echo "API_KEY length: ${#API_KEY}"
          fi
        env:
          API_KEY: ${{ secrets.API_KEY }}
      
      - name: Build
        run: npm run build
        env:
          API_KEY: ${{ secrets.API_KEY }}
          GEMINI_API_KEY: ${{ secrets.API_KEY }}
          NODE_ENV: production
        continue-on-error: false
      
      - name: Verify API_KEY in built code
        run: |
          if grep -q "API_KEY.*undefined\|API_KEY.*null\|API_KEY.*\"\"" dist/assets/*.js 2>/dev/null; then
            echo "⚠️ Warning: API_KEY might not be set correctly in built code"
          else
            echo "✅ Build completed - checking if API_KEY is in code..."
            if grep -q "API_KEY" dist/assets/*.js 2>/dev/null; then
              echo "✅ API_KEY found in built code"
            else
              echo "⚠️ API_KEY not found in built code (might be minified)"
            fi
          fi
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

